package com.veryvery.controller;

import java.io.File;
import java.io.UnsupportedEncodingException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.multipart.MultipartFile;

@Controller
@RequestMapping("/upload/*")
public class FileController {

	@Autowired
	ResourceLoader rsLoader;

	// 상대경로 파일 업로드 (실패)
	@RequestMapping(value = "uploadForm.do", method = RequestMethod.GET)
	public String uploadForm() {
		return "uploadFile";
	}

//	@RequestMapping(value = "fileUpload.do", method = RequestMethod.POST)
//	public String fileUpload(MultipartFile myfile) throws UnsupportedEncodingException, Exception {
//		String filename = myfile.getOriginalFilename();
//		System.out.println("업로드 파일 이름 : " + filename);
//		filename = new String(filename.getBytes("8859_1"), "utf-8");
//		Resource resource = rsLoader.getResource("/WEB-INF/views/upload");
//		myfile.transferTo(new File(resource.getFile().getCanonicalPath() + "/" + filename));
//		System.out.println("파일 업로드 위치 : " + resource.getFile().getCanonicalPath());
//		System.out.println("파일 저장 성공");
//		return "redirect:/";
//	}
	//파일 업로드 처리
	@RequestMapping(value="/fileUplaod.do", method = RequestMethod.POST)
	public String fileUpload(MultipartFile myfile) throws UnsupportedEncodingException, Exception {
		String filename = myfile.getOriginalFilename();
		System.out.println("업로드 파일 이름 : "+filename);
		filename = new String(filename.getBytes("8859_1"), "utf-8");
		Resource resource = rsLoader.getResource("/WEB-INF/views/upload");
		myfile.transferTo(new File(resource.getFile().getCanonicalPath()+"/"+filename)); //상대경로
		System.out.println("파일 업로드 위치 : "+resource.getFile().getCanonicalPath());
		//myfile.transferTo(new File("d:/kim3/fileUplad/"+filename)); //절대경로
		System.out.println("파일 저장 성공");
		return "redirect:/";
	}
	/* D:\\kim3\\jsp3\\.metadata\\.plugins\\org.eclipse.wst.server.core
	\\tmp0\\wtpwebapps\\web05\\WEB-INF\\views\\upload\\ 에 저장됨 */
	
	//다수파일업로드
	@RequestMapping(value="/uploadMulti.do", method = RequestMethod.GET) //다수파일 업로드 폼 로딩
	public String uploadMulti() {
		return "uploadMulti";
}
	@RequestMapping(value="/multiFileUplaod.do", method = RequestMethod.POST) //다수파일 업로드 폼 로딩
	public String multiFileUpload(MultipartFile[] files) {
		String uploadFolder = "D:\\kim3\\jsp3\\web05\\src\\main\\webapp\\WEB-INF\\views\\upload";
		for(MultipartFile file : files) {
			String fileName = file.getOriginalFilename();
			System.out.println("업로드 파일 이름 : "+fileName);
			System.out.println("업로드 파일 크기 : "+file.getSize());
			File saveFile = new File(uploadFolder, fileName);
		try {
			file.transferTo(saveFile);
		} catch(Exception e) {
			System.out.println("파일 처리 오류");
			e.printStackTrace();
		}
		}
		return "redirect:/";
	}

}
